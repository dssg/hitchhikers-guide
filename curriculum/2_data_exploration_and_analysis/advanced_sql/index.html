



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="DSSG Hitchhikers guide">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.2.0">
    
    
      
        <title>SQL - DSSG Hitchhickers guide</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.750b69bd.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.224b79ff.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700|Ubuntu+Mono">
        <style>body,input{font-family:"Ubuntu","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Ubuntu Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="red" data-md-color-accent="deep-orange">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#advanced-sql-for-data-analysis" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="DSSG Hitchhickers guide" class="md-header-nav__button md-logo">
          
            <i class="md-icon">bubble_chart</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              DSSG Hitchhickers guide
            </span>
            <span class="md-header-nav__topic">
              SQL
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/dssg/hitchhikers-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/hitchhikers-guide
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="DSSG Hitchhickers guide" class="md-nav__button md-logo">
      
        <i class="md-icon">bubble_chart</i>
      
    </a>
    DSSG Hitchhickers guide
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/dssg/hitchhikers-guide/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    dssg/hitchhikers-guide
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../what-is-dssg/" title="What is in this curriculum?" class="md-nav__link">
      What is in this curriculum?
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../host-cities/" title="DSSG Locations" class="md-nav__link">
      DSSG Locations
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      DSSG Manual (for summer fellows)
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        DSSG Manual (for summer fellows)
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../dssg-manual/" title="What is in this manual" class="md-nav__link">
      What is in this manual
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../dssg-manual/conduct-culture-and-communications/goals/" title="Goals of the Fellowship" class="md-nav__link">
      Goals of the Fellowship
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../dssg-manual/conduct-culture-and-communications/environment/" title="The DSSG Environment" class="md-nav__link">
      The DSSG Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../dssg-manual/summer-overview/" title="Summer overview" class="md-nav__link">
      Summer overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../dssg-manual/conduct-culture-and-communications/" title="Code of conduct" class="md-nav__link">
      Code of conduct
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5" checked>
    
    <label class="md-nav__link" for="nav-5">
      Curriculum
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Curriculum
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../" title="What is in this curriculum" class="md-nav__link">
      What is in this curriculum
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../sample/" title="Sample curriculum for Summer 2019" class="md-nav__link">
      Sample curriculum for Summer 2019
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3" type="checkbox" id="nav-5-3">
    
    <label class="md-nav__link" for="nav-5-3">
      Skills you need throughout a project
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-3">
        Skills you need throughout a project
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../skills/ethics_bias_fairness/" title="Ethics, Bias, Fairness" class="md-nav__link">
      Ethics, Bias, Fairness
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3-2" type="checkbox" id="nav-5-3-2">
    
    <label class="md-nav__link" for="nav-5-3-2">
      Communication
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-3-2">
        Communication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../communication/" title="Intro" class="md-nav__link">
      Intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../communication/presentations/" title="Presentations" class="md-nav__link">
      Presentations
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../communication/writing/" title="Writing reports" class="md-nav__link">
      Writing reports
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../eda/visualization/" title="Visualization" class="md-nav__link">
      Visualization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../communication/user_interface/" title="User interface" class="md-nav__link">
      User interface
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-3-3" type="checkbox" id="nav-5-3-3">
    
    <label class="md-nav__link" for="nav-5-3-3">
      Good Software Practices
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-3-3">
        Good Software Practices
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../programming_best_practices/" title="Intro" class="md-nav__link">
      Intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../programming_best_practices/legible-good-code/" title="Legible, good code" class="md-nav__link">
      Legible, good code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../programming_best_practices/test-test-test/" title="Writing tests" class="md-nav__link">
      Writing tests
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../programming_best_practices/reproducible-software/" title="Reproducible software" class="md-nav__link">
      Reproducible software
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../programming_best_practices/pimp-my-dotfiles/" title="Pimp my dotfiles!" class="md-nav__link">
      Pimp my dotfiles!
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../skills/domain_understanding/" title="Domain Understanding" class="md-nav__link">
      Domain Understanding
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-4" type="checkbox" id="nav-5-4">
    
    <label class="md-nav__link" for="nav-5-4">
      Project Scoping
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-4">
        Project Scoping
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../scoping/overview/" title="Scoping overview" class="md-nav__link">
      Scoping overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scoping/project_workflow/" title="Project workflow" class="md-nav__link">
      Project workflow
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scoping/dme/" title="Data Maturity evaluation" class="md-nav__link">
      Data Maturity evaluation
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../scoping/deliverables/" title="Project deliverables" class="md-nav__link">
      Project deliverables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6" type="checkbox" id="nav-5-6">
    
    <label class="md-nav__link" for="nav-5-6">
      Tech setup
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-6">
        Tech setup
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/software-setup/" title="Software you need" class="md-nav__link">
      Software you need
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/command-line-tools/" title="Command line intro" class="md-nav__link">
      Command line intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-6-3" type="checkbox" id="nav-5-6-3">
    
    <label class="md-nav__link" for="nav-5-6-3">
      Git and github
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-6-3">
        Git and github
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/git-and-github/" title="What is it?" class="md-nav__link">
      What is it?
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/git-and-github/basic_git_tutorial/" title="Basic tutorial" class="md-nav__link">
      Basic tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/git-and-github/group_tutorial/" title="Group tutorial" class="md-nav__link">
      Group tutorial
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/git-and-github/branching_and_merging/" title="Advanced notes" class="md-nav__link">
      Advanced notes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/git-and-github/githubflow/github-flow.html" title="Git Workflow" class="md-nav__link">
      Git Workflow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software/basic_python/" title="Python" class="md-nav__link">
      Python
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software/basic_sql/" title="SQL" class="md-nav__link">
      SQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../setup/good_repos/" title="Good repos" class="md-nav__link">
      Good repos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../0_before_you_start/TechnicalWorkflowAndBestPractices/" title="Technical workflow" class="md-nav__link">
      Technical workflow
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7" type="checkbox" id="nav-5-7">
    
    <label class="md-nav__link" for="nav-5-7">
      Getting, storing, and linking data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-7">
        Getting, storing, and linking data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../1_getting_and_keeping_data/" title="Intro" class="md-nav__link">
      Intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../get_data/data-security-primer/" title="Data security" class="md-nav__link">
      Data security
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7-3" type="checkbox" id="nav-5-7-3">
    
    <label class="md-nav__link" for="nav-5-7-3">
      Get data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-7-3">
        Get data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../1_getting_and_keeping_data/basic-web-scraping/" title="APIs and scrapping" class="md-nav__link">
      APIs and scrapping
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../get_data/images/" title="Working with images" class="md-nav__link">
      Working with images
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../text-analysis/" title="Working with text" class="md-nav__link">
      Working with text
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../1_getting_and_keeping_data/csv-to-db/" title="Flat files" class="md-nav__link">
      Flat files
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7-4" type="checkbox" id="nav-5-7-4">
    
    <label class="md-nav__link" for="nav-5-7-4">
      Store data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-7-4">
        Store data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../1_getting_and_keeping_data/reproducible_ETL/" title="ETL - cleaning, loading" class="md-nav__link">
      ETL - cleaning, loading
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7-4-2" type="checkbox" id="nav-5-7-4-2">
    
    <label class="md-nav__link" for="nav-5-7-4-2">
      DBs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-5-7-4-2">
        DBs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../dbs/why/" title="Why a DB?" class="md-nav__link">
      Why a DB?
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../dbs/relational_design/" title="Designing a DB" class="md-nav__link">
      Designing a DB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../dbs/getting_data_in/" title="Getting data in" class="md-nav__link">
      Getting data in
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../dbs/getting_data_out/" title="Getting data out" class="md-nav__link">
      Getting data out
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../software/sql_data_analysis/" title="Analyzing data (SQL)" class="md-nav__link">
      Analyzing data (SQL)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../dbs/other_types/" title="Other types of DBs" class="md-nav__link">
      Other types of DBs
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-7-5" type="checkbox" id="nav-5-7-5">
    
    <label class="md-nav__link" for="nav-5-7-5">
      Link data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-7-5">
        Link data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../record-linkage/" title="Record linkage" class="md-nav__link">
      Record linkage
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-8" type="checkbox" id="nav-5-8" checked>
    
    <label class="md-nav__link" for="nav-5-8">
      Data Exploration
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-8">
        Data Exploration
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Introduction to EDA" class="md-nav__link">
      Introduction to EDA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../eda/visualization/" title="Visualization" class="md-nav__link">
      Visualization
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        SQL
      </label>
    
    <a href="./" title="SQL" class="md-nav__link md-nav__link--active">
      SQL
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#test-your-connection" title="Test your connection" class="md-nav__link">
    Test your connection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-punchline" title="The punchline" class="md-nav__link">
    The punchline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-food-inspections-data-set" title="The food inspections data set" class="md-nav__link">
    The food inspections data set
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-basic-tasks-in-a-data-analysis-project" title="Some basic tasks in a data analysis project" class="md-nav__link">
    Some basic tasks in a data analysis project
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-and-manipulating-the-data" title="Cleaning and manipulating the data" class="md-nav__link">
    Cleaning and manipulating the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manipulating-the-data-json" title="Manipulating the data: JSON" class="md-nav__link">
    Manipulating the data: JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-your-code-and-maybe-gaining-a-little-speed-ctes" title="Cleaning your code and (maybe) gaining a little speed: CTEs" class="md-nav__link">
    Cleaning your code and (maybe) gaining a little speed: CTEs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-unstructured-data" title="Querying unstructured data" class="md-nav__link">
    Querying unstructured data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datawarehousing" title=""Datawarehousing"" class="md-nav__link">
    "Datawarehousing"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datawarehousing-functions" title="Datawarehousing functions" class="md-nav__link">
    Datawarehousing functions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analytical-questions-looking-through-the-window" title="Analytical Questions: Looking through the window" class="md-nav__link">
    Analytical Questions: Looking through the window
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analytical-questions-looking-through-the-window_1" title="Analytical Questions: Looking through the window" class="md-nav__link">
    Analytical Questions: Looking through the window
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#window-functions" title="Window functions" class="md-nav__link">
    Window functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytical-questions-using-the-previous-row" title="Analytical Questions: Using the previous row" class="md-nav__link">
    Analytical Questions: Using the previous row
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytical-questions-using-some-other-rows" title="Analytical Questions: Using some other rows" class="md-nav__link">
    Analytical Questions: Using some other rows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql-for-loops" title="SQL "for loops"" class="md-nav__link">
    SQL "for loops"
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#meaning-in-text" title="Meaning in text" class="md-nav__link">
    Meaning in text
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-text-search" title="Full Text Search" class="md-nav__link">
    Full Text Search
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spatial-awareness" title="Spatial awareness" class="md-nav__link">
    Spatial awareness
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spatial-queries" title="Spatial queries" class="md-nav__link">
    Spatial queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" title="Appendix" class="md-nav__link">
    Appendix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-database" title="Creating the database" class="md-nav__link">
    Creating the database
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../data-exploration-in-python/" title="Python/Pandas" class="md-nav__link">
      Python/Pandas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../gis_analysis/postgis-workshop/" title="GIS" class="md-nav__link">
      GIS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../text-analysis/" title="Text" class="md-nav__link">
      Text
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../network-analysis/" title="Network" class="md-nav__link">
      Network
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../eda/tableau/" title="Tableau" class="md-nav__link">
      Tableau
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../eda/data_stories/" title="Data stories concept and code" class="md-nav__link">
      Data stories concept and code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../eda/clustering/" title="ML as a data exploration tool (Clustering)" class="md-nav__link">
      ML as a data exploration tool (Clustering)
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-9" type="checkbox" id="nav-5-9">
    
    <label class="md-nav__link" for="nav-5-9">
      Computational and Data Analysis Methods
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-9">
        Computational and Data Analysis Methods
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../3_modeling_and_machine_learning/" title="Intro" class="md-nav__link">
      Intro
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../3_modeling_and_machine_learning/machine-learning/" title="Machine Learning" class="md-nav__link">
      Machine Learning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methods/causal_inference/" title="Causal inference methods" class="md-nav__link">
      Causal inference methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methods/social_science/" title="Social science methods" class="md-nav__link">
      Social science methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methods/statistical_analysis/" title="Other statistical analysis methods" class="md-nav__link">
      Other statistical analysis methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../methods/or/" title="OR/optimization methods" class="md-nav__link">
      OR/optimization methods
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/templates/" title="Problem Templates in Social Good and Public Policy" class="md-nav__link">
      Problem Templates in Social Good and Public Policy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11" type="checkbox" id="nav-5-11">
    
    <label class="md-nav__link" for="nav-5-11">
      Practical Steps in Using Machine Learning to Solve Social Problems
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-11">
        Practical Steps in Using Machine Learning to Solve Social Problems
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-1" type="checkbox" id="nav-5-11-1">
    
    <label class="md-nav__link" for="nav-5-11-1">
      Building an ML Pipeline
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-1">
        Building an ML Pipeline
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/pipeline/" title="ML pipeline I" class="md-nav__link">
      ML pipeline I
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-2" type="checkbox" id="nav-5-11-2">
    
    <label class="md-nav__link" for="nav-5-11-2">
      Set up problem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-2">
        Set up problem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/problem_formulation/" title="ML problem formulation" class="md-nav__link">
      ML problem formulation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/checklist/" title="ML Checklist" class="md-nav__link">
      ML Checklist
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/templates/" title="Templates of policy problems" class="md-nav__link">
      Templates of policy problems
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-3" type="checkbox" id="nav-5-11-3">
    
    <label class="md-nav__link" for="nav-5-11-3">
      Labels/Outcomes
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-3">
        Labels/Outcomes
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/labels/one_or_many/" title="One or many" class="md-nav__link">
      One or many
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/labels/implications/" title="Implications of a label" class="md-nav__link">
      Implications of a label
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-4" type="checkbox" id="nav-5-11-4">
    
    <label class="md-nav__link" for="nav-5-11-4">
      Features/Predictors
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-4">
        Features/Predictors
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/feature_engineering/intro/" title="Feature engineering" class="md-nav__link">
      Feature engineering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/feature_engineering/workshop/" title="Workshop on feature engineering" class="md-nav__link">
      Workshop on feature engineering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/feature_engineering/case_studies/" title="Case studies" class="md-nav__link">
      Case studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-5" type="checkbox" id="nav-5-11-5">
    
    <label class="md-nav__link" for="nav-5-11-5">
      Validation Methodology
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-5">
        Validation Methodology
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/validation/process_and_goal/" title="Process and goal" class="md-nav__link">
      Process and goal
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/validation/kfold/" title="K-fold cross-validation" class="md-nav__link">
      K-fold cross-validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/validation/tcc/" title="Temporal cross-validation" class="md-nav__link">
      Temporal cross-validation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/validation/field_trials/" title="Field trials" class="md-nav__link">
      Field trials
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-6" type="checkbox" id="nav-5-11-6">
    
    <label class="md-nav__link" for="nav-5-11-6">
      Evalution Metrics
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-6">
        Evalution Metrics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/metrics/overview/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/metrics/examples/" title="Examples" class="md-nav__link">
      Examples
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-7" type="checkbox" id="nav-5-11-7">
    
    <label class="md-nav__link" for="nav-5-11-7">
      Models/Methods
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-7">
        Models/Methods
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/methods/" title="Machine learning methods" class="md-nav__link">
      Machine learning methods
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/tips/" title="Practical tips on how to use them, parameters, etc." class="md-nav__link">
      Practical tips on how to use them, parameters, etc.
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-8" type="checkbox" id="nav-5-11-8">
    
    <label class="md-nav__link" for="nav-5-11-8">
      Model selection
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-8">
        Model selection
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/selection/audition/" title="Audition" class="md-nav__link">
      Audition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-8-2" type="checkbox" id="nav-5-11-8-2">
    
    <label class="md-nav__link" for="nav-5-11-8-2">
      What metrics do we care about?
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="4">
      <label class="md-nav__title" for="nav-5-11-8-2">
        What metrics do we care about?
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/selection/performance/" title="Performance" class="md-nav__link">
      Performance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/selection/stability/" title="Stability" class="md-nav__link">
      Stability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/selection/interpretability/" title="Interpretability" class="md-nav__link">
      Interpretability
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/selection/bias/" title="Bias" class="md-nav__link">
      Bias
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-9" type="checkbox" id="nav-5-11-9">
    
    <label class="md-nav__link" for="nav-5-11-9">
      Postmodeling
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-9">
        Postmodeling
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/understanding/" title="Model understanding" class="md-nav__link">
      Model understanding
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/feature_importance/" title="Feature importance" class="md-nav__link">
      Feature importance
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/model_comparison/" title="Comparing different models" class="md-nav__link">
      Comparing different models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/list_comparison/" title="Comparing lists" class="md-nav__link">
      Comparing lists
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/error_analysis/" title="Error analysis" class="md-nav__link">
      Error analysis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../ml/postmodeling/bias_analysis/" title="Bias analysis" class="md-nav__link">
      Bias analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-11-10" type="checkbox" id="nav-5-11-10">
    
    <label class="md-nav__link" for="nav-5-11-10">
      Experimental design
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-5-11-10">
        Experimental design
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../experimental_design/intro/" title="Experiment design" class="md-nav__link">
      Experiment design
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../experimental_design/case_studies/" title="Case studies" class="md-nav__link">
      Case studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-12" type="checkbox" id="nav-5-12">
    
    <label class="md-nav__link" for="nav-5-12">
      Deployment and Maintenance
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-12">
        Deployment and Maintenance
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/how_to/" title="How to deploy" class="md-nav__link">
      How to deploy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/monitor/" title="Monitor" class="md-nav__link">
      Monitor
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/update/" title="Update" class="md-nav__link">
      Update
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deployment/advanced_pipelines/" title="Advanced pipelines" class="md-nav__link">
      Advanced pipelines
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#test-your-connection" title="Test your connection" class="md-nav__link">
    Test your connection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-punchline" title="The punchline" class="md-nav__link">
    The punchline
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-food-inspections-data-set" title="The food inspections data set" class="md-nav__link">
    The food inspections data set
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#some-basic-tasks-in-a-data-analysis-project" title="Some basic tasks in a data analysis project" class="md-nav__link">
    Some basic tasks in a data analysis project
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-and-manipulating-the-data" title="Cleaning and manipulating the data" class="md-nav__link">
    Cleaning and manipulating the data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manipulating-the-data-json" title="Manipulating the data: JSON" class="md-nav__link">
    Manipulating the data: JSON
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-your-code-and-maybe-gaining-a-little-speed-ctes" title="Cleaning your code and (maybe) gaining a little speed: CTEs" class="md-nav__link">
    Cleaning your code and (maybe) gaining a little speed: CTEs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#querying-unstructured-data" title="Querying unstructured data" class="md-nav__link">
    Querying unstructured data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datawarehousing" title=""Datawarehousing"" class="md-nav__link">
    "Datawarehousing"
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#datawarehousing-functions" title="Datawarehousing functions" class="md-nav__link">
    Datawarehousing functions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analytical-questions-looking-through-the-window" title="Analytical Questions: Looking through the window" class="md-nav__link">
    Analytical Questions: Looking through the window
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analytical-questions-looking-through-the-window_1" title="Analytical Questions: Looking through the window" class="md-nav__link">
    Analytical Questions: Looking through the window
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#window-functions" title="Window functions" class="md-nav__link">
    Window functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytical-questions-using-the-previous-row" title="Analytical Questions: Using the previous row" class="md-nav__link">
    Analytical Questions: Using the previous row
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#analytical-questions-using-some-other-rows" title="Analytical Questions: Using some other rows" class="md-nav__link">
    Analytical Questions: Using some other rows
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sql-for-loops" title="SQL "for loops"" class="md-nav__link">
    SQL "for loops"
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#meaning-in-text" title="Meaning in text" class="md-nav__link">
    Meaning in text
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#full-text-search" title="Full Text Search" class="md-nav__link">
    Full Text Search
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#spatial-awareness" title="Spatial awareness" class="md-nav__link">
    Spatial awareness
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#spatial-queries" title="Spatial queries" class="md-nav__link">
    Spatial queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#appendix" title="Appendix" class="md-nav__link">
    Appendix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-the-database" title="Creating the database" class="md-nav__link">
    Creating the database
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/dssg/hitchhikers-guide/edit/master/sources/curriculum/2_data_exploration_and_analysis/advanced_sql/README.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="advanced-sql-for-data-analysis">Advanced SQL for data analysis<a class="headerlink" href="#advanced-sql-for-data-analysis" title="Permanent link">#</a></h1>
<h2 id="test-your-connection">Test your connection<a class="headerlink" href="#test-your-connection" title="Permanent link">#</a></h2>
<p>If you are using <code>psql</code> use the following command to connect:</p>
<div class="codehilite"><pre><span></span>psql postgresql://your_host:your_password@db_host:db_port/training
</pre></div>


<p>If you are using a graphical client:</p>
<div class="codehilite"><pre><span></span>host: db_host
port: db_port
username: your_username
password: your_password
db: training
</pre></div>


<p><strong>NOTE</strong> It is very likely that you are using a different database, please
adjust the previous connection parameters.</p>
<h2 id="the-punchline">The punchline<a class="headerlink" href="#the-punchline" title="Permanent link">#</a></h2>
<p>Databases are not only for <strong>storage</strong> they are for manipulating in an
efficient way your data: Try to do the data manipulation near to where
the data is located.</p>
<h2 id="the-food-inspections-data-set">The food inspections data set<a class="headerlink" href="#the-food-inspections-data-set" title="Permanent link">#</a></h2>
<p>The data represents the inspections made in different facilities in
the area of Chicago.</p>
<p>There are different types of inspections, different types of
facilities and different results (or outcomes) of that
inspections. Also the data contains the
types of violations and text descriptions in free form about the
violations.</p>
<p>Obviously, we have spatio-temporal data (i.e. the inspections happen
in a given time at some place).</p>
<h2 id="some-basic-tasks-in-a-data-analysis-project">Some basic tasks in a data analysis project<a class="headerlink" href="#some-basic-tasks-in-a-data-analysis-project" title="Permanent link">#</a></h2>
<ul>
<li>Cleaning the data</li>
<li>Manipulating the data</li>
<li>Create new <em>FeatureS</em></li>
<li>Create new views of the data</li>
<li>Answering analytical questions</li>
</ul>
<h2 id="cleaning-and-manipulating-the-data">Cleaning and manipulating the data<a class="headerlink" href="#cleaning-and-manipulating-the-data" title="Permanent link">#</a></h2>
<p>We already prepared a partial "cleaning" of the data. That data is
located in the <code>schema</code> <code>cleaned</code>.</p>
<h4>Hands-on</h4>
<p>Expected time: 2 minutes</p>
<p>Feel the data:</p>
<ul>
<li>How many tables are there?</li>
<li>Which are the respective columns?</li>
<li>How many rows per table?</li>
<li>Any idea about how to join them?</li>
<li>Look at the inspection <code>2078651</code>, How many violations does it had?</li>
</ul>
<p>Let's move on, for most of the analytical purposes (related to data
science) we need a consolidated view of the entities in our data,
i.e. we need to <em>denormalize</em> the data. We will call to this new table
the <em>semantic</em> view of the data.</p>
<p>If we do a simple join between this two tables, we will get many
rows per inspection. And that will complicate our future analysis. So
we need a way of collapse those rows, without losing data.</p>
<h2 id="manipulating-the-data-json">Manipulating the data: JSON<a class="headerlink" href="#manipulating-the-data-json" title="Permanent link">#</a></h2>
<p><code>PostgreSQL</code> supports collapsing several rows using
<a href="https://www.postgresql.org/docs/9.3/static/functions-array.html">arrays</a>
or
<a href="https://www.postgresql.org/docs/current/static/functions-json.html">JSON</a>.
We will transform the rows of the <code>cleaned.violations</code> table into
<code>json</code>
and we will aggregate those into a <code>json array</code>.</p>
<p>We will do this together using the functions  <code>row_to_json</code> and <code>json_agg.</code>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
           <span class="n">json_agg</span><span class="p">(</span>
            <span class="n">row_to_json</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="o">*</span><span class="p">)</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
    <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
    <span class="k">where</span> <span class="n">inspection</span>  <span class="o">=</span> <span class="s1">&#39;2078651&#39;</span>
</pre></div></p>
<p>We could improve the output (make it more pretty) using the function <code>json_build_object</code>, and
a simple <code>group by</code></p>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
            <span class="n">v</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span>
            <span class="n">v</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span>
            <span class="n">v</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
            <span class="n">json_agg</span><span class="p">(</span>
                     <span class="n">json_build_object</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
                                       <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                                       <span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="k">comment</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
    <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
    <span class="k">where</span> <span class="n">inspection</span>  <span class="o">=</span> <span class="s1">&#39;2078651&#39;</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">v</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="nb">date</span><span class="p">;</span>  <span class="c1">-- We need a group by since we are using an aggregator function</span>
</pre></div>

<h4>Hands-on</h4>
<p>Estimated time: 1 minute
Manipulate the previous query statement
and try to join it with the inspections (You should get
only one row)</p>
<h2 id="cleaning-your-code-and-maybe-gaining-a-little-speed-ctes">Cleaning your code and (maybe) gaining a little speed: CTEs<a class="headerlink" href="#cleaning-your-code-and-maybe-gaining-a-little-speed-ctes" title="Permanent link">#</a></h2>
<p>It is very probable that you use a sub-query in you previous hands-on.</p>
<p>There is a better way of doing it, and is using <a href="https://www.postgresql.org/docs/current/static/queries-with.html">Common Table Expressions (CTEs)</a>
also know as <em>WITH queries</em>.</p>
<p>This will improve your readability (be nice wih the future you!) and in some cases speed
improvements</p>
<div class="highlight"><pre><span></span>    <span class="c1">-- You first define your subquery and assign a name to it</span>
    <span class="c1">-- This will work as a &quot;common table&quot;</span>
    <span class="k">with</span> <span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
         <span class="k">select</span>
            <span class="n">v</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span>
            <span class="n">v</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span>
            <span class="n">v</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span>
            <span class="n">json_agg</span><span class="p">(</span>
                    <span class="n">json_build_object</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
                                      <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
                                      <span class="s1">&#39;comment&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">.</span><span class="k">comment</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
          <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
          <span class="k">group</span> <span class="k">by</span> <span class="n">v</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="nb">date</span>
    <span class="p">)</span>

    <span class="c1">-- Then you can use it</span>

    <span class="k">select</span> <span class="n">i</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">violations</span>
    <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
    <span class="k">left</span> <span class="k">join</span> <span class="n">violations</span> <span class="k">as</span> <span class="n">v</span> <span class="c1">-- Here we are using the &quot;common table&quot;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">inspection</span><span class="p">);</span>   <span class="c1">-- we can use this, since both tables have the same column name</span>
</pre></div>

<p>You can use several CTEs, just remove all except the first <code>with</code> and
separate them by colons. We will show you more examples later in this workshop.</p>
<h2 id="querying-unstructured-data">Querying unstructured data<a class="headerlink" href="#querying-unstructured-data" title="Permanent link">#</a></h2>
<p>We created for you the table <code>semantic.events</code>, and is very similar
to the results of your last hands-on.</p>
<p>For querying <code>json</code> unstructured data, PostgreSQL provides you with the
operator <code>-&gt;&gt;</code>. This operator <em>extracts</em> the <strong>value</strong> of the <strong>key</strong> in the json.</p>
<p>We first need to transform the array of <code>json</code> objects (<em>unnest</em> it) into
rows (using <code>jsonb_array_elements</code>, and
then use the operator <code>-&gt;&gt;</code> for retrieving the value of the specified
key.</p>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
         <span class="k">select</span>
            <span class="n">event_id</span><span class="p">,</span>
            <span class="n">jsonb_array_elements</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="k">as</span> <span class="n">violations</span> <span class="c1">-- This returns several rows</span>
         <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
         <span class="k">where</span> <span class="n">event_id</span> <span class="o">=</span> <span class="s1">&#39;104246&#39;</span>
    <span class="p">)</span>

    <span class="k">select</span> <span class="n">event_id</span><span class="p">,</span>
           <span class="n">violations</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;code&#39;</span> <span class="k">as</span> <span class="n">violation_code</span><span class="p">,</span> <span class="c1">-- We want the value of the key &#39;code&#39;</span>
           <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
    <span class="k">from</span> <span class="n">violations</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">violation_code</span><span class="p">;</span>
</pre></div>

<h4>Hands-on</h4>
<p>Estimated time: 2 minutes
Modify this query to get the facility (using <code>license_num</code>) in which the
inspectors found the biggest number of violation code 40.</p>
<h2 id="datawarehousing">"Datawarehousing"<a class="headerlink" href="#datawarehousing" title="Permanent link">#</a></h2>
<p>Generate data for a BI dashboard, that shows all total number of
inspections, and their results,
per city, facility type, month, year including totals and subtotals</p>
<h4>Hands-on</h4>
<p>Estimated time: 2 minutes
How to solve this using basic sql?</p>
<h3 id="datawarehousing-functions">Datawarehousing functions<a class="headerlink" href="#datawarehousing-functions" title="Permanent link">#</a></h3>
<p><code>PostgreSQL</code> overloaded the operator <code>GROUP BY</code>, so besides their normal
use, now you can produce reports of aggregation metrics by sets
(<code>GROUPING SETS</code>),
hierarchy (<code>ROLLUP</code>) and combinations (<code>CUBE</code>) in a simple query.</p>
<div class="highlight"><pre><span></span>    <span class="c1">-- This doesn&#39;t give you the subtotals and totals</span>
    <span class="k">select</span>
            <span class="k">extract</span><span class="p">(</span><span class="k">month</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="k">month</span><span class="p">,</span>
            <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
            <span class="n">facility_type</span><span class="p">,</span>
            <span class="k">result</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">number_of_inspections</span>
    <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="k">where</span> <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2017</span> <span class="k">and</span>
          <span class="k">extract</span><span class="p">(</span><span class="k">month</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span>  <span class="o">=</span> <span class="mi">1</span>
    <span class="k">group</span> <span class="k">by</span> <span class="k">month</span><span class="p">,</span> <span class="k">year</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="k">result</span>
    <span class="c1">--group by GROUPING SETS (month, year, facility_type, result, ())</span>
    <span class="c1">--group by ROLLUP (month, year, facility_type, result)</span>
    <span class="c1">--group by CUBE (month, year, facility_type, result)</span>
</pre></div>

<p><strong>NOTE</strong> Instead of the function <code>extract(...)</code> you could use <code>date_trunc(...)</code></p>
<h4>Hands-on</h4>
<p>Estimated time: 5 minutes
Play with the different commented lines in the example query, if
you only one the subtotal per <code>facility_type</code> and <code>city</code>, Which one
you should use?</p>
<h2 id="analytical-questions-looking-through-the-window">Analytical Questions: Looking through the window<a class="headerlink" href="#analytical-questions-looking-through-the-window" title="Permanent link">#</a></h2>
<p>How do each facility' number of inspections compares to others in
their facility type? Total of inspections? Average of inspections?
Distance to the top? Distance from the average? How percentage of
inspections where used in a particular facility?</p>
<h4>Hands-on:</h4>
<p>Estimated time: 5 minutes
Try to solve this by yourself using only <code>SELECT</code>, <code>GROUP BY</code>, <code>HAVING</code>, <code>WHERE</code></p>
<h2 id="analytical-questions-looking-through-the-window_1">Analytical Questions: Looking through the window<a class="headerlink" href="#analytical-questions-looking-through-the-window_1" title="Permanent link">#</a></h2>
<h3 id="window-functions">Window functions<a class="headerlink" href="#window-functions" title="Permanent link">#</a></h3>
<ul>
<li>They are similar to aggregate functions, but instead of operating on
    groups of rows to produce a single row, they act on rows related to
    the current row to produce the same amount of rows.</li>
<li>There are several <a href="https://www.postgresql.org/docs/current/static/functions-window.html">window functions</a>
    like <code>row_number</code>, <code>rank</code>, <code>ntile</code>, <code>lag</code>, <code>lead</code>, <code>first_value</code>, <code>last_value</code>,
    <code>nth_value</code>.</li>
<li>And you can use any aggregation functions: <code>sum</code>, <code>count</code>, <code>avg</code>,
    <code>json_agg</code>, <code>array_agg</code>, etc</li>
<li>Those functions are used in <a href="https://www.postgresql.org/docs/current/static/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS">window function calls</a>.</li>
</ul>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">failures_per_facility</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">facility_type</span><span class="p">,</span>
            <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">inspections</span>
    <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="k">where</span> <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2015</span> <span class="k">and</span> <span class="n">facility_type</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="k">year</span>
    <span class="p">)</span>

    <span class="k">select</span>
            <span class="k">year</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">facility_type</span><span class="p">,</span>
            <span class="n">inspections</span><span class="p">,</span>
            <span class="k">sum</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span> <span class="k">as</span> <span class="ss">&quot;total inspections per type&quot;</span><span class="p">,</span>
            <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">inspections</span><span class="p">::</span><span class="nb">decimal</span><span class="o">/</span><span class="k">sum</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>  <span class="k">as</span> <span class="ss">&quot;% of inspections&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="k">avg</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;avg inspections per type&quot;</span><span class="p">,</span>
            <span class="n">inspections</span> <span class="o">-</span> <span class="k">avg</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span> <span class="k">as</span> <span class="ss">&quot;distance from avg&quot;</span><span class="p">,</span>
            <span class="n">first_value</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w2</span> <span class="k">as</span> <span class="ss">&quot;max inspections per type&quot;</span><span class="p">,</span>
            <span class="n">inspections</span> <span class="o">-</span> <span class="n">first_value</span><span class="p">(</span><span class="n">inspections</span><span class="p">)</span> <span class="n">over</span> <span class="n">w2</span> <span class="k">as</span> <span class="ss">&quot;distance from top 1&quot;</span><span class="p">,</span>
            <span class="n">dense_rank</span><span class="p">()</span> <span class="n">over</span> <span class="n">w2</span> <span class="k">as</span> <span class="n">rank</span><span class="p">,</span>
            <span class="p">(</span><span class="n">nth_value</span><span class="p">(</span><span class="n">inspections</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">over</span> <span class="n">w3</span> <span class="o">/</span> <span class="n">inspections</span><span class="p">::</span><span class="nb">decimal</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="ss">&quot;rate to top 1&quot;</span><span class="p">,</span>
            <span class="n">ntile</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="n">over</span> <span class="n">w2</span> <span class="k">as</span> <span class="n">ntile</span>
    <span class="k">from</span> <span class="n">failures_per_facility</span>
    <span class="k">where</span> <span class="n">facility_type</span> <span class="o">=</span> <span class="s1">&#39;wholesale&#39;</span>
    <span class="n">window</span>
           <span class="n">w1</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">facility_type</span><span class="p">,</span> <span class="k">year</span><span class="p">),</span>
           <span class="n">w2</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">facility_type</span><span class="p">,</span> <span class="k">year</span> <span class="k">order</span> <span class="k">by</span> <span class="n">inspections</span> <span class="k">desc</span><span class="p">),</span>
           <span class="n">w3</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">facility_type</span><span class="p">,</span> <span class="k">year</span> <span class="k">order</span> <span class="k">by</span> <span class="n">inspections</span> <span class="k">desc</span> <span class="k">rows</span> <span class="k">between</span> <span class="n">unbounded</span> <span class="n">preceding</span> <span class="k">and</span> <span class="n">unbounded</span> <span class="n">following</span><span class="p">)</span>
    <span class="k">limit</span> <span class="mi">10</span><span class="p">;</span>
</pre></div>

<h4>Hands-on</h4>
<p>Estimated time: 5 minutes
Change the previous query to show the number of 'Fail' <code>results</code>
instead the number of inspections.
<em>Hint:</em> Instead of using</p>
<div class="codehilite"><pre><span></span>sum(
    case results
        when &#39;Fail&#39;
        then 1
        else 0
    end
) as failures
</pre></div>


<p>you can use <code>count(*) filter (where results = 'Fail')</code></p>
<h3 id="analytical-questions-using-the-previous-row">Analytical Questions: Using the previous row<a class="headerlink" href="#analytical-questions-using-the-previous-row" title="Permanent link">#</a></h3>
<p>At a given date, number of days since the last inspection?</p>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
    <span class="n">entity_id</span><span class="p">,</span>
    <span class="nb">date</span> <span class="k">as</span> <span class="n">inspection_date</span><span class="p">,</span>
    <span class="n">lag</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span> <span class="k">as</span> <span class="n">previous_inspection</span><span class="p">,</span>
    <span class="n">age</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span> <span class="n">lag</span><span class="p">(</span><span class="nb">date</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">over</span> <span class="n">w1</span><span class="p">)</span> <span class="k">as</span> <span class="n">time_since_last_inspection</span>
    <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="k">where</span> <span class="n">facility_type</span> <span class="o">=</span> <span class="s1">&#39;wholesale&#39;</span>
    <span class="n">window</span> <span class="n">w1</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">entity_id</span> <span class="k">order</span> <span class="k">by</span> <span class="nb">date</span> <span class="k">asc</span><span class="p">)</span>
    <span class="k">order</span> <span class="k">by</span> <span class="n">entity_id</span><span class="p">,</span> <span class="nb">date</span> <span class="k">asc</span> <span class="p">;</span>
</pre></div>

<h3 id="analytical-questions-using-some-other-rows">Analytical Questions: Using some other rows<a class="headerlink" href="#analytical-questions-using-some-other-rows" title="Permanent link">#</a></h3>
<p>Number of violations in the last 3 inspections</p>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
            <span class="n">event_id</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="n">jsonb_array_elements</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
    <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="p">),</span>

    <span class="n">number_of_violations</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
            <span class="n">event_id</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">num_of_violations</span>
    <span class="k">from</span> <span class="n">violations</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="nb">date</span>
    <span class="p">)</span>

    <span class="k">select</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="n">num_of_violations</span><span class="p">,</span>
            <span class="k">sum</span><span class="p">(</span><span class="n">num_of_violations</span><span class="p">)</span> <span class="n">over</span> <span class="n">w</span> <span class="k">as</span> <span class="n">running_total</span><span class="p">,</span>
            <span class="n">array_agg</span><span class="p">(</span><span class="n">num_of_violations</span><span class="p">)</span> <span class="n">over</span> <span class="n">w</span> <span class="k">as</span> <span class="n">previous_violations</span>
    <span class="k">from</span> <span class="n">number_of_violations</span>
    <span class="k">where</span>  <span class="n">entity_id</span> <span class="o">=</span> <span class="mi">11326</span>
    <span class="n">window</span> <span class="n">w</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">entity_id</span> <span class="k">order</span> <span class="k">by</span> <span class="nb">date</span> <span class="k">asc</span> <span class="k">rows</span> <span class="k">between</span> <span class="mi">3</span> <span class="n">preceding</span> <span class="k">and</span> <span class="mi">1</span> <span class="n">preceding</span><span class="p">)</span>
</pre></div>

<h4>Hands-on</h4>
<p>Estimated time: 5 minutes</p>
<ul>
<li>Which are the facilities with more changes in the <code>risk</code> column
    (i.e. lower -&gt; medium, medium -&gt; high, high -&gt; medium)? Could you
    count how to many changes where "up" and how many where "down"?</li>
</ul>
<div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="n">risks</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
            <span class="nb">date</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">risk</span><span class="p">,</span>
            <span class="n">lag</span><span class="p">(</span><span class="n">risk</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">over</span> <span class="n">w</span> <span class="k">as</span> <span class="n">previous_risk</span>
    <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="n">window</span> <span class="n">w</span> <span class="k">as</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">entity_id</span> <span class="k">order</span> <span class="k">by</span> <span class="nb">date</span> <span class="k">asc</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">select</span>
            <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="k">case</span>
                 <span class="k">when</span> <span class="n">risk</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span> <span class="k">and</span> <span class="n">previous_risk</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span> <span class="k">then</span> <span class="mi">1</span>
                 <span class="k">when</span> <span class="n">risk</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span> <span class="k">and</span> <span class="n">previous_risk</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span> <span class="k">then</span> <span class="mi">1</span>
            <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">up</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="k">case</span>
                 <span class="k">when</span> <span class="n">risk</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span> <span class="k">and</span> <span class="n">previous_risk</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span> <span class="k">then</span> <span class="mi">1</span>
                 <span class="k">when</span> <span class="n">risk</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span> <span class="k">and</span> <span class="n">previous_risk</span> <span class="o">=</span> <span class="s1">&#39;medium&#39;</span> <span class="k">then</span> <span class="mi">1</span>
            <span class="k">end</span><span class="p">)</span> <span class="k">as</span> <span class="n">down</span>
    <span class="k">from</span> <span class="n">risks</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">entity_id</span><span class="p">,</span> <span class="k">extract</span><span class="p">(</span><span class="k">year</span> <span class="k">from</span> <span class="nb">date</span><span class="p">)</span>
    <span class="k">order</span> <span class="k">by</span> <span class="k">year</span><span class="p">,</span> <span class="n">up</span> <span class="k">desc</span><span class="p">,</span> <span class="n">down</span> <span class="k">desc</span>
    <span class="k">limit</span> <span class="mi">10</span>
</pre></div>

<h2 id="sql-for-loops">SQL "for loops"<a class="headerlink" href="#sql-for-loops" title="Permanent link">#</a></h2>
<p>Let's try to solve the following: For each facility still active, with
less than 1 year, In which failed inspection they got the most
violations inspected?</p>
<p>One way to solve this is using <code>LATERAL</code> joins</p>
<p><div class="highlight"><pre><span></span>    <span class="k">select</span>
    <span class="n">entity_id</span> <span class="k">as</span> <span class="n">facility</span><span class="p">,</span>
    <span class="n">start_time</span><span class="p">,</span>
    <span class="nb">date</span> <span class="k">as</span> <span class="n">inspected_at</span><span class="p">,</span>
    <span class="n">event_id</span> <span class="k">as</span> <span class="n">inpection</span><span class="p">,</span>
    <span class="n">number_of_violations</span>
    <span class="k">from</span> <span class="p">(</span>
           <span class="k">select</span>
           <span class="n">entity_id</span><span class="p">,</span>
           <span class="n">start_time</span><span class="p">,</span>
           <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">age</span><span class="p">(</span><span class="n">now</span><span class="p">(),</span> <span class="n">start_time</span><span class="p">))</span> <span class="k">as</span> <span class="n">years_in_service</span>
           <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
           <span class="k">where</span>
           <span class="n">end_time</span> <span class="k">is</span> <span class="k">null</span>  <span class="c1">-- Still active</span>
           <span class="k">group</span> <span class="k">by</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">start_time</span>
           <span class="k">having</span> <span class="n">date_part</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">age</span><span class="p">(</span><span class="n">now</span><span class="p">(),</span> <span class="n">start_time</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">1</span>
           <span class="p">)</span> <span class="k">as</span> <span class="n">facilities</span><span class="p">,</span>
           <span class="k">lateral</span> <span class="p">(</span> <span class="c1">--subquery</span>
           <span class="k">select</span>
              <span class="n">event_id</span><span class="p">,</span>
              <span class="nb">date</span><span class="p">,</span>
              <span class="n">jsonb_array_length</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="k">as</span> <span class="n">number_of_violations</span>
           <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
           <span class="k">where</span>
           <span class="n">entity_id</span> <span class="o">=</span> <span class="n">facilities</span><span class="p">.</span><span class="n">entity_id</span>
           <span class="k">and</span> <span class="k">result</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
           <span class="k">group</span> <span class="k">by</span> <span class="n">event_id</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="n">violations</span>
           <span class="k">order</span> <span class="k">by</span> <span class="mi">3</span>
           <span class="k">desc</span> <span class="k">limit</span> <span class="mi">1</span>
           <span class="p">)</span> <span class="n">inspections</span>
    <span class="k">order</span> <span class="k">by</span> <span class="n">number_of_violations</span> <span class="k">desc</span><span class="p">;</span>
</pre></div>
The equivalent <em>pseudo-code</em> is</p>
<div class="highlight"><pre><span></span>    results = []
    for entity_row in semantic.entities:
        for inspection_row in subquery:
            results.append( (entity_row, inspection_row) )  # We are doing more complicated things, but is just an example
</pre></div>

<h2 id="meaning-in-text">Meaning in text<a class="headerlink" href="#meaning-in-text" title="Permanent link">#</a></h2>
<p>Which are the most common words descriptions of the violations?</p>
<h2 id="full-text-search">Full Text Search<a class="headerlink" href="#full-text-search" title="Permanent link">#</a></h2>
<p>PostgreSQL has a lot of capabilities for working with <a href="https://www.postgresql.org/docs/current/static/textsearch.html">text data</a>
(<em>fuzzy search</em>, <em>n-grams</em>, etc) that you can use for <em>searching inside</em>
the text.</p>
<p>But the same techniques allows you to do some text analysis. The first
steps of it are: removing stop words, stemming, calculating
frequencies and then <em>vectorization</em>.</p>
<p>See the following example:</p>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
           <span class="k">comment</span><span class="p">,</span>
           <span class="k">replace</span><span class="p">(</span><span class="n">plainto_tsquery</span><span class="p">(</span><span class="k">comment</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span> <span class="s1">&#39; &amp; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cleaned_comment</span><span class="p">,</span>
           <span class="n">to_tsvector</span><span class="p">(</span><span class="k">comment</span><span class="p">)</span> <span class="k">as</span> <span class="n">vectorized_comment</span>
    <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</pre></div>

<p>Let's create a <strong>word count</strong> (from here you can create a word cloud, if
you like it). We will use the table <code>text_analysis.comments</code></p>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
            <span class="n">regexp_split_to_table</span><span class="p">(</span><span class="n">cleaned_comment</span><span class="p">,</span> <span class="s1">&#39;\s+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">word</span><span class="p">,</span>
            <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">word_count</span>
    <span class="k">from</span> <span class="n">text_analysis</span><span class="p">.</span><span class="n">comments</span>
    <span class="k">group</span> <span class="k">by</span> <span class="n">word</span>
    <span class="k">order</span> <span class="k">by</span> <span class="n">word_count</span>
    <span class="k">desc</span> <span class="k">limit</span> <span class="mi">50</span><span class="p">;</span>
</pre></div>

<h2 id="spatial-awareness">Spatial awareness<a class="headerlink" href="#spatial-awareness" title="Permanent link">#</a></h2>
<p>Which restaurants with high risk which had an inspection are located near to public schools?</p>
<div class="highlight"><pre><span></span>    <span class="k">select</span>
            <span class="k">distinct</span> <span class="k">on</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">school_nm</span><span class="p">)</span>
            <span class="n">entity_id</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">school_nm</span> <span class="k">as</span> <span class="ss">&quot;school&quot;</span>
    <span class="k">from</span> <span class="n">gis</span><span class="p">.</span><span class="n">public_schools</span> <span class="k">as</span> <span class="n">s</span> <span class="k">join</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">as</span> <span class="n">i</span>
         <span class="k">on</span> <span class="n">ST_DWithin</span><span class="p">(</span><span class="n">geography</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">wkb_geometry</span><span class="p">),</span> <span class="n">geography</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span> <span class="c1">-- This is the distance in meters</span>
    <span class="k">where</span> <span class="n">facility_type</span> <span class="o">=</span> <span class="s1">&#39;restaurant&#39;</span> <span class="k">and</span> <span class="n">risk</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span><span class="p">;</span>
</pre></div>

<h3 id="spatial-queries">Spatial queries<a class="headerlink" href="#spatial-queries" title="Permanent link">#</a></h3>
<p>PostgresSQL has an extension called <a href="http://postgis.net/">PosGIS</a>, that allows you to do <strong>Spatial Joins</strong>, i.e. use geographical data
to answer questions as <em>What is near?</em> <em>What is inside this area?</em> <em>What intersects or connect with this?</em></p>
<h4>Hands-on</h4>
<p>Estimated time: 5 min</p>
<ul>
<li>There is another table: <code>gis.boundaries</code>, use the function
    <code>ST_Contains</code> to calculate the number of facilities per zip code?
    Compare that with the count using <code>zip_code</code> column in the
    <code>semantic.events</code>
    <strong>Hint</strong>: Use a CTE&#x2026;</li>
</ul>
<h4>Hands-on</h4>
<p>Estimated time: 10min</p>
<ul>
<li>Generate a list with the top 5 facilities with the higher number of
    violations which are near to public schools</li>
</ul>
<h2 id="appendix">Appendix<a class="headerlink" href="#appendix" title="Permanent link">#</a></h2>
<h2 id="creating-the-database">Creating the database<a class="headerlink" href="#creating-the-database" title="Permanent link">#</a></h2>
<p>First the <code>raw.inspections</code> table</p>
<div class="highlight"><pre><span></span>    <span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">raw</span><span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span> <span class="p">(</span>
    <span class="n">inspection</span> <span class="nb">varchar</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">DBA_Name</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">AKA_Name</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">license_Num</span> <span class="nb">decimal</span><span class="p">,</span>
    <span class="n">facility_type</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">risk</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">address</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">city</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="k">state</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">zip</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="nb">date</span> <span class="nb">date</span><span class="p">,</span>
    <span class="k">type</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">results</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">violations</span> <span class="nb">varchar</span><span class="p">,</span>
    <span class="n">latitude</span> <span class="nb">decimal</span><span class="p">,</span>
    <span class="n">longitude</span> <span class="nb">decimal</span><span class="p">,</span>
    <span class="k">location</span> <span class="nb">varchar</span>
    <span class="p">);</span>
</pre></div>

<p>Then we fill that table with data</p>
<div class="highlight"><pre><span></span>    \copy raw.inspections from program &#39;curl &quot;https://data.cityofchicago.org/api/views/4ijn-s7e5/rows.csv?accessType=DOWNLOAD&quot;&#39; HEADER CSV
</pre></div>

<p>After that, we created a more "clean" version of the data</p>
<div class="highlight"><pre><span></span>    <span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">cleaned</span> <span class="p">;</span>
    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">cascade</span><span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">with</span> <span class="n">cleaned</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
    <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">results</span><span class="p">))</span> <span class="k">as</span> <span class="k">result</span><span class="p">,</span>
    <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">dba_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">facility</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">aka_name</span><span class="p">))</span> <span class="k">as</span> <span class="n">facility_aka</span><span class="p">,</span>
    <span class="k">case</span> <span class="k">when</span>
    <span class="n">facility_type</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">else</span> <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">facility_type</span><span class="p">))</span>
    <span class="k">end</span> <span class="k">as</span> <span class="n">facility_type</span><span class="p">,</span>
    <span class="k">lower</span><span class="p">(</span><span class="k">substring</span><span class="p">(</span><span class="n">risk</span> <span class="k">from</span> <span class="s1">&#39;\((.+)\)&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">risk</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">address</span><span class="p">))</span> <span class="k">as</span> <span class="n">address</span><span class="p">,</span>
    <span class="n">zip</span> <span class="k">as</span> <span class="n">zip_code</span><span class="p">,</span>
    <span class="k">substring</span><span class="p">(</span>
    <span class="n">btrim</span><span class="p">(</span><span class="k">lower</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="k">type</span><span class="p">,</span> <span class="s1">&#39;liquor&#39;</span><span class="p">,</span> <span class="s1">&#39;task force&#39;</span><span class="p">,</span> <span class="s1">&#39;gi&#39;</span><span class="p">)))</span>
    <span class="k">from</span> <span class="s1">&#39;canvass|task force|complaint|food poisoning|consultation|license|tag removal&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">type</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">ST_SetSRID</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">),</span> <span class="mi">4326</span><span class="p">)::</span><span class="n">geography</span> <span class="k">as</span> <span class="k">location</span>  <span class="c1">-- We use geography so the measurements are in meters</span>
    <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
    <span class="k">where</span> <span class="n">zip</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>  <span class="c1">-- removing NULL zip codes</span>
    <span class="p">)</span>

    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">cleaned</span> <span class="k">where</span> <span class="k">type</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="p">);</span>

    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">cascade</span><span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
    <span class="n">inspection</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
    <span class="n">license_num</span><span class="p">::</span><span class="nb">integer</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">::</span><span class="nb">date</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">as</span> <span class="n">code</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">as</span> <span class="n">description</span><span class="p">,</span>
    <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">as</span> <span class="k">comment</span><span class="p">,</span>
    <span class="p">(</span><span class="k">case</span>
      <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">then</span> <span class="k">NULL</span>
      <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">1</span> <span class="k">and</span> <span class="mi">14</span> <span class="k">then</span> <span class="s1">&#39;critical&#39;</span> <span class="c1">-- From the documentation</span>
      <span class="k">when</span> <span class="n">btrim</span><span class="p">(</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">])::</span><span class="nb">int</span> <span class="k">between</span> <span class="mi">15</span> <span class="k">and</span> <span class="mi">29</span>  <span class="k">then</span> <span class="s1">&#39;serious&#39;</span>
      <span class="k">else</span> <span class="s1">&#39;minor&#39;</span>
    <span class="k">end</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">severity</span> <span class="k">from</span>
    <span class="p">(</span>
    <span class="k">select</span>
    <span class="n">inspection</span><span class="p">,</span>
    <span class="n">license_num</span><span class="p">,</span>
    <span class="nb">date</span><span class="p">,</span>
    <span class="n">regexp_split_to_array</span><span class="p">(</span>   <span class="c1">-- Create an array we will split the code, description, comment</span>
      <span class="n">regexp_split_to_table</span><span class="p">(</span> <span class="c1">-- Create a row per each comment we split by |</span>
        <span class="n">coalesce</span><span class="p">(</span>            <span class="c1">-- If there isn&#39;t a violation add &#39;- Comments:&#39;</span>
          <span class="n">regexp_replace</span><span class="p">(</span><span class="n">violations</span><span class="p">,</span> <span class="s1">&#39;[\n\r]+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span> <span class="p">)</span>  <span class="c1">-- Remove line breaks</span>
        <span class="p">,</span> <span class="s1">&#39;- Comments:&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="s1">&#39;\|&#39;</span><span class="p">)</span>  <span class="c1">-- Split the violations</span>
    <span class="p">,</span> <span class="s1">&#39;(?&lt;=\d+)\.\s*|\s*-\s*Comments:&#39;</span><span class="p">)</span>  <span class="c1">-- Split each violation in three</span>
    <span class="c1">-- , &#39;\.\s*|\s*-\s*Comments:&#39;)  -- Split each violation in three (Use this if your postgresql is kind off old</span>
     <span class="k">as</span> <span class="n">tuple</span>
    <span class="k">from</span> <span class="n">raw</span><span class="p">.</span><span class="n">inspections</span>
    <span class="k">where</span> <span class="n">results</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;Fail&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass w/ Conditions&#39;</span><span class="p">)</span> <span class="k">and</span> <span class="n">license_num</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">t</span>
    <span class="p">);</span>
</pre></div>

<p>The <code>semantic.entities</code> table</p>
<div class="highlight"><pre><span></span>    <span class="k">create</span> <span class="k">schema</span> <span class="k">if</span> <span class="k">not</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">;</span>

    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">cascade</span><span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>

    <span class="k">with</span> <span class="n">entities_date</span> <span class="k">as</span> <span class="p">(</span>

      <span class="k">select</span>
      <span class="n">license_num</span><span class="p">,</span>
      <span class="n">facility</span><span class="p">,</span>
      <span class="n">facility_aka</span><span class="p">,</span>
      <span class="n">facility_type</span><span class="p">,</span>
      <span class="n">address</span><span class="p">,</span>
      <span class="n">zip_code</span><span class="p">,</span>
      <span class="k">location</span><span class="p">,</span>
      <span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">start_time</span><span class="p">,</span>
      <span class="k">max</span><span class="p">(</span><span class="k">case</span> <span class="k">when</span>
      <span class="k">result</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;out of business&#39;</span><span class="p">,</span> <span class="s1">&#39;business not located&#39;</span><span class="p">)</span>
      <span class="k">then</span>
      <span class="nb">date</span>
      <span class="k">else</span>
      <span class="k">NULL</span>
      <span class="k">end</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="k">as</span> <span class="n">end_time</span>
      <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span>

    <span class="p">)</span>

    <span class="k">select</span> <span class="k">distinct</span>
       <span class="n">dense_rank</span><span class="p">()</span> <span class="n">over</span> <span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">as</span> <span class="n">entity_id</span><span class="p">,</span>
       <span class="n">license_num</span><span class="p">,</span>
       <span class="n">facility</span><span class="p">,</span>
       <span class="n">facility_aka</span><span class="p">,</span>
       <span class="n">facility_type</span><span class="p">,</span>
       <span class="n">address</span><span class="p">,</span>
       <span class="n">zip_code</span><span class="p">,</span>
       <span class="k">location</span><span class="p">,</span>
       <span class="n">start_time</span><span class="p">,</span>
       <span class="n">end_time</span>
    <span class="k">from</span> <span class="n">entities_date</span>
       <span class="n">window</span> <span class="n">w</span> <span class="k">as</span> <span class="p">(</span><span class="k">order</span> <span class="k">by</span> <span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span> <span class="c1">-- This kinda defines an unique facility</span>
    <span class="p">);</span>


    <span class="c1">-- Adding some indices</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">);</span>

    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_license_num_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

    <span class="c1">-- Spatial index</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

    <span class="k">create</span> <span class="k">index</span> <span class="n">entities_full_key_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
</pre></div>

<p>The <code>semantics.events</code>:</p>
<div class="highlight"><pre><span></span>    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">cascade</span><span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">as</span> <span class="p">(</span>

    <span class="k">with</span> <span class="n">entities</span> <span class="k">as</span> <span class="p">(</span>
      <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">entities</span>
    <span class="p">),</span>

    <span class="n">inspections</span> <span class="k">as</span> <span class="p">(</span>
    <span class="k">select</span>
    <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
    <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
    <span class="n">jsonb_agg</span><span class="p">(</span>
        <span class="n">jsonb_build_object</span><span class="p">(</span>
            <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;severity&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">severity</span><span class="p">,</span>
        <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="k">comment</span>
        <span class="p">)</span>
    <span class="k">order</span>  <span class="k">by</span> <span class="n">code</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
    <span class="k">from</span> <span class="n">cleaned</span><span class="p">.</span><span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">cleaned</span><span class="p">.</span><span class="n">violations</span> <span class="k">as</span> <span class="n">v</span>
    <span class="k">on</span> <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">inspection</span>
    <span class="k">group</span> <span class="k">by</span>
    <span class="n">i</span><span class="p">.</span><span class="n">inspection</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">license_num</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_aka</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
    <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span>
    <span class="p">)</span>

    <span class="k">select</span>
    <span class="n">i</span><span class="p">.</span><span class="n">inspection</span> <span class="k">as</span> <span class="n">event_id</span><span class="p">,</span>
    <span class="n">e</span><span class="p">.</span><span class="n">entity_id</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">risk</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="k">result</span><span class="p">,</span>
    <span class="n">e</span><span class="p">.</span><span class="n">facility_type</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="n">zip_code</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">location</span><span class="p">,</span>
    <span class="n">i</span><span class="p">.</span><span class="n">violations</span>
    <span class="k">from</span> <span class="n">entities</span> <span class="k">as</span> <span class="n">e</span>
    <span class="k">inner</span> <span class="k">join</span>
    <span class="n">inspections</span> <span class="k">as</span> <span class="n">i</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">license_num</span><span class="p">,</span> <span class="n">facility</span><span class="p">,</span> <span class="n">facility_aka</span><span class="p">,</span> <span class="n">facility_type</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">)</span>

    <span class="p">);</span>

    <span class="c1">-- Add some indices</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_entity_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_event_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="k">type</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_date_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span><span class="p">(</span><span class="nb">date</span> <span class="k">desc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_facility_type_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">facility_type</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_zip_code_ix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>  <span class="p">(</span><span class="n">zip_code</span><span class="p">);</span>

    <span class="c1">-- Spatial index</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_location_gix</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gist</span> <span class="p">(</span><span class="k">location</span><span class="p">);</span>

    <span class="c1">-- JSONB indices</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_violations</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span><span class="p">);</span>
    <span class="k">create</span> <span class="k">index</span> <span class="n">events_violations_json_path</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="k">using</span> <span class="n">gin</span><span class="p">(</span><span class="n">violations</span> <span class="n">jsonb_path_ops</span><span class="p">);</span>

    <span class="k">create</span> <span class="k">index</span> <span class="n">events_event_entity_zip_code_date</span> <span class="k">on</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span> <span class="p">(</span><span class="n">event_id</span> <span class="k">desc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">,</span> <span class="n">zip_code</span><span class="p">,</span> <span class="nb">date</span> <span class="k">desc</span> <span class="n">nulls</span> <span class="k">last</span><span class="p">);</span>
</pre></div>

<p>Next we will create the table for text analytics:</p>
<div class="highlight"><pre><span></span>    <span class="k">create</span> <span class="k">schema</span> <span class="n">text_analysis</span><span class="p">;</span>

    <span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">text_analysis</span><span class="p">.</span><span class="n">comments</span> <span class="p">;</span>

    <span class="k">create</span> <span class="k">table</span> <span class="n">text_analysis</span><span class="p">.</span><span class="n">comments</span> <span class="k">as</span> <span class="p">(</span>

    <span class="k">with</span> <span class="n">violations</span> <span class="k">as</span> <span class="p">(</span>
         <span class="k">select</span>
            <span class="n">event_id</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">jsonb_array_elements</span><span class="p">(</span><span class="n">violations</span><span class="p">)</span> <span class="k">as</span> <span class="n">violations</span>
            <span class="k">from</span> <span class="n">semantic</span><span class="p">.</span><span class="n">events</span>
    <span class="p">),</span> <span class="n">cleaned</span> <span class="k">as</span> <span class="p">(</span>
       <span class="k">select</span>
            <span class="n">event_id</span><span class="p">,</span>
            <span class="n">entity_id</span><span class="p">,</span>
            <span class="n">violations</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;comment&#39;</span> <span class="k">as</span> <span class="n">original_comment</span><span class="p">,</span>
            <span class="k">replace</span><span class="p">(</span><span class="n">plainto_tsquery</span><span class="p">(</span><span class="n">violations</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;comment&#39;</span><span class="p">)::</span><span class="nb">text</span><span class="p">,</span> <span class="s1">&#39; &amp; &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cleaned_comment</span><span class="p">,</span>
            <span class="n">to_tsvector</span><span class="p">(</span><span class="n">violations</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;comment&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vectorized_comment</span>
       <span class="k">from</span> <span class="n">violations</span>
       <span class="k">where</span> <span class="n">btrim</span><span class="p">(</span><span class="n">violations</span> <span class="o">-&gt;&gt;</span> <span class="s1">&#39;comment&#39;</span><span class="p">)</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;&#39;</span>
    <span class="p">)</span>

    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">cleaned</span>
    <span class="p">);</span>
</pre></div>

<p>And finally the tables for the spatial analysis. The data was
downloaded from the <a href="https://data.cityofchicago.org/browse?tags=gis">Chicago Data Portal</a>. In particular we are using
the location of the schools (<em>Chicago Public Schools - School Locations SY1415</em>)
and the Chicago ZIP codes boundaries  (<em>Boundaries - ZIP Codes</em>). Both
data sources use the <code>WSG84</code> projection, by the way.</p>
<p>You can check that you have everything setup to upload the data with
the following command (I recommend to use <code>ogr2ogr</code>)</p>
<div class="codehilite"><pre><span></span>ogrinfo -ro PG:&#39;host=0.0.0.0 port=5434 user=your_user password=some_password dbname=food&#39;
</pre></div>


<p>Again, adjust the connection string accordingly.</p>
<p>Then unzip the files that you downloaded, first the boundaries</p>
<div class="codehilite"><pre><span></span>unzip &quot;Boundaries - ZIP Codes.zip&quot;
</pre></div>


<p>(This will create 4 files in your directory, all of them with the
prefix <code>geo_export_c0962a58-51c1-4ea4-af11-acb7ed233465</code>, the extensions
will be <code>shp</code> (the spatial data), <code>dbf</code> (the data in tabular form), <code>prj</code>
(specifies the projection) and <code>shx</code> (index information)</p>
<p>And now the schools:</p>
<div class="codehilite"><pre><span></span>unzip &#39;Chicago Public Schools - School Locations SY1415.zip&#39;
</pre></div>


<p>Be careful, now there are 4 new files, all of them with the prefix:
<code>geo_export_ebe2869c-9bf6-4a04-ae14-a01062f8fa2a</code>, and the same
extensions as before.</p>
<p>Finally,</p>
<div class="codehilite"><pre><span></span>ogr2ogr -f &quot;PostgreSQL&quot; \
 PG:&#39;host=0.0.0.0 port=8888 user=your_user password=some_password dbname=training&#39; \
  geo_export_c0962a58-51c1-4ea4-af11-acb7ed233465.shp \
  -nln gis.boundaries  -nlt PROMOTE_TO_MULTI -lco precision=NO
</pre></div>


<p><strong>NOTE</strong>: I added the <code>-nlt PROMOTE_TO_MULTI</code> because the data source had
mixed spatial types (Multipolygon and polygon), see
<a href="https://trac.osgeo.org/gdal/ticket/4939">https://trac.osgeo.org/gdal/ticket/4939</a> for details.</p>
<p><strong>NOTE</strong>: I added the <code>-lco precision=NO</code> due to a precision error with the
data:</p>
<p>See this Stackoverflow question for details: <a href="https://gis.stackexchange.com/questions/254671/ogr2ogr-error-importing-shapefile-into-postgis-numeric-field-overflow">https://gis.stackexchange.com/questions/254671/ogr2ogr-error-importing-shapefile-into-postgis-numeric-field-overflow</a></p>
<div class="codehilite"><pre><span></span>ogr2ogr -f &quot;PostgreSQL&quot; \
PG:&#39;host=0.0.0.0 port=8888 user=your_user password=some_password dbname=training&#39; \
geo_export_ebe2869c-9bf6-4a04-ae14-a01062f8fa2a.shp \
  -nln gis.public_schools
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../eda/visualization/" title="Visualization" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Visualization
              </span>
            </div>
          </a>
        
        
          <a href="../data-exploration-in-python/" title="Python/Pandas" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Python/Pandas
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/dssg/hitchhikers-guide" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/datascifellows" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/company/center-for-data-science-and-public-policy-university-of-chicago" class="md-footer-social__link fa fa-linkedin"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.39abc4af.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
        <script src="../../../js/mermaid.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>